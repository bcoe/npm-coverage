<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for ./lib/cache/add-local.js</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="../../prettify.css">
    <link rel="stylesheet" href="../../base.css">
    <style type='text/css'>
        div.coverage-summary .sorter {
            background-image: url(../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class="header medium">
    <h1>Code coverage report for <span class="entity">./lib/cache/add-local.js</span></h1>
    <h2>
        Statements: <span class="metric">75.38% <small>(49 / 65)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Branches: <span class="metric">65.31% <small>(32 / 49)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Functions: <span class="metric">100% <small>(9 / 9)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Lines: <span class="metric">82.76% <small>(48 / 58)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Ignored: <span class="metric"><span class="ignore-none">none</span></span> &nbsp;&nbsp;&nbsp;&nbsp;
    </h2>
    <div class="path"><a href="../../index.html">All files</a> &#187; <a href="index.html">./lib/cache/</a> &#187; add-local.js</div>
</div>
<div class="body">
<pre><table class="coverage">
<tr><td class="line-count">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124</td><td class="line-coverage"><span class="cline-any cline-yes">143</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">143</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">142</span>
<span class="cline-any cline-yes">80</span>
<span class="cline-any cline-yes">80</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">80</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">142</span>
<span class="cline-any cline-yes">79</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">79</span>
<span class="cline-any cline-yes">79</span>
<span class="cline-any cline-yes">79</span>
<span class="cline-any cline-yes">79</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">79</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">80</span>
<span class="cline-any cline-yes">72</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">142</span>
<span class="cline-any cline-yes">72</span>
<span class="cline-any cline-yes">72</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">72</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">72</span>
<span class="cline-any cline-yes">72</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">72</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">72</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">72</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">72</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">72</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">72</span>
<span class="cline-any cline-yes">72</span>
<span class="cline-any cline-yes">72</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">72</span>
<span class="cline-any cline-yes">72</span>
<span class="cline-any cline-yes">72</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">72</span>
<span class="cline-any cline-yes">72</span>
<span class="cline-any cline-yes">72</span>
<span class="cline-any cline-yes">72</span>
<span class="cline-any cline-yes">72</span>
<span class="cline-any cline-yes">71</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">71</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">71</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">142</span>
<span class="cline-any cline-yes">71</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">71</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">71</span>
<span class="cline-any cline-yes">71</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">71</span>
<span class="cline-any cline-yes">71</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">var assert = require("assert")
  , path = require("path")
  , mkdir = require("mkdirp")
  , chownr = require("chownr")
  , pathIsInside = require("path-is-inside")
  , readJson = require("read-package-json")
  , log = require("npmlog")
  , npm = require("../npm.js")
  , tar = require("../utils/tar.js")
  , deprCheck = require("../utils/depr-check.js")
  , getCacheStat = require("./get-stat.js")
  , cachedPackageRoot = require("./cached-package-root.js")
  , addLocalTarball = require("./add-local-tarball.js")
  , sha = require("sha")
  , inflight = require("inflight")
&nbsp;
module.exports = addLocal
&nbsp;
function addLocal (p, pkgData, cb_) {
  assert(typeof p === "object", "must have spec info")
  assert(typeof cb === "function", "must have callback")
&nbsp;
  pkgData = pkgData || {}
&nbsp;
  function cb (er, data) {
    <span class="missing-if-branch" title="if path not taken" >I</span>if (er) {
<span class="cstat-no" title="statement not covered" >      log.error("addLocal", "Could not install %s", p.spec)</span>
<span class="cstat-no" title="statement not covered" >      return cb_(er)</span>
    }
    <span class="missing-if-branch" title="else path not taken" >E</span>if (data &amp;&amp; !data._fromGithub) {
      data._from = path.relative(npm.prefix, p.spec) || "."
      var resolved = path.relative(npm.prefix, p.spec)
      if (resolved) data._resolved = "file:"+resolved
    }
    return cb_(er, data)
  }
&nbsp;
  if (p.type === "directory") {
    addLocalDirectory(p.spec, pkgData, null, cb)
  }
  else {
    addLocalTarball(p.spec, pkgData, null, cb)
  }
}
&nbsp;
// At this point, if shasum is set, it's something that we've already
// read and checked.  Just stashing it in the data at this point.
function addLocalDirectory (p, pkgData, shasum, cb) {
  assert(pkgData, "must pass package data")
  assert(typeof cb === "function", "must have callback")
&nbsp;
  // if it's a folder, then read the package.json,
  // tar it to the proper place, and add the cache tar
  <span class="missing-if-branch" title="if path not taken" >I</span>if (pathIsInside(p, npm.cache)) <span class="cstat-no" title="statement not covered" >return cb(new Error(</span>
    "Adding a cache directory to the cache will make the world implode."))
&nbsp;
  readJson(path.join(p, "package.json"), false, function (er, data) {
    <span class="missing-if-branch" title="if path not taken" >I</span>if (er) <span class="cstat-no" title="statement not covered" >return cb(er)</span>
&nbsp;
    <span class="missing-if-branch" title="if path not taken" >I</span>if (!data.name) {
<span class="cstat-no" title="statement not covered" >      return cb(new Error("No name provided in package.json"))</span>
    }
    else <span class="missing-if-branch" title="if path not taken" >I</span>if (pkgData.name &amp;&amp; <span class="branch-1 cbranch-no" title="branch not covered" >pkgData.name !== data.name)</span> {
<span class="cstat-no" title="statement not covered" >      return cb(new Error(</span>
        "Invalid package: expected " + pkgData.name + " but found " + data.name
      ))
    }
&nbsp;
    <span class="missing-if-branch" title="if path not taken" >I</span>if (!data.version) {
<span class="cstat-no" title="statement not covered" >      return cb(new Error("No version provided in package.json"))</span>
    }
    else <span class="missing-if-branch" title="if path not taken" >I</span>if (pkgData.version &amp;&amp; <span class="branch-1 cbranch-no" title="branch not covered" >pkgData.version !== data.version)</span> {
<span class="cstat-no" title="statement not covered" >      return cb(new Error(</span>
        "Invalid package: expected " + pkgData.name + "@" + pkgData.version +
          " but found " + data.name + "@" + data.version
      ))
    }
&nbsp;
    deprCheck(data)
&nbsp;
    // pack to {cache}/name/ver/package.tgz
    var root = cachedPackageRoot(data)
    var tgz = path.resolve(root, "package.tgz")
    var pj = path.resolve(root, "package/package.json")
&nbsp;
    var wrapped = inflight(tgz, next)
    <span class="missing-if-branch" title="if path not taken" >I</span>if (!wrapped) <span class="cstat-no" title="statement not covered" >return log.verbose("addLocalDirectory", tgz, "already in flight; waiting")</span>
    log.verbose("addLocalDirectory", tgz, "not in flight; packing")
&nbsp;
    getCacheStat(function (er, cs) {
      mkdir(path.dirname(pj), function (er, made) {
        <span class="missing-if-branch" title="if path not taken" >I</span>if (er) <span class="cstat-no" title="statement not covered" >return cb(er)</span>
        var fancy = !pathIsInside(p, npm.tmp)
        tar.pack(tgz, p, data, fancy, function (er) {
          <span class="missing-if-branch" title="if path not taken" >I</span>if (er) {
<span class="cstat-no" title="statement not covered" >            log.error("addLocalDirectory", "Could not pack", p, "to", tgz)</span>
<span class="cstat-no" title="statement not covered" >            return cb(er)</span>
          }
&nbsp;
          <span class="missing-if-branch" title="if path not taken" >I</span>if (!cs || isNaN(cs.uid) || isNaN(cs.gid)) <span class="cstat-no" title="statement not covered" >wrapped()</span>
&nbsp;
          chownr(made || tgz, cs.uid, cs.gid, wrapped)
        })
      })
    })
&nbsp;
    function next (er) {
      <span class="missing-if-branch" title="if path not taken" >I</span>if (er) <span class="cstat-no" title="statement not covered" >return cb(er)</span>
      // if we have the shasum already, just add it
      <span class="missing-if-branch" title="if path not taken" >I</span>if (shasum) {
<span class="cstat-no" title="statement not covered" >        return addLocalTarball(tgz, data, shasum, cb)</span>
      } else {
        sha.get(tgz, function (er, shasum) {
          <span class="missing-if-branch" title="if path not taken" >I</span>if (er) {
<span class="cstat-no" title="statement not covered" >            return cb(er)</span>
          }
          data._shasum = shasum
          return addLocalTarball(tgz, data, shasum, cb)
        })
      }
    }
  })
}
&nbsp;</pre></td></tr>
</table></pre>

</div>
<div class="footer">
    <div class="meta">Generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Sat May 16 2015 16:39:59 GMT-0700 (PDT)</div>
</div>
<script src="../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../sorter.js"></script>
</body>
</html>
